<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aviator Game</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #0f1923;
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a242d;
        }
        ::-webkit-scrollbar-thumb {
            background: #ef4444;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #dc2626;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background-color: #4b5563;
            border-radius: 13px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .toggle-switch.active {
            background-color: #ef4444;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(24px);
        }

        .toggle-switch input {
            display: none;
        }

        .game-canvas {
            background: linear-gradient(180deg, #1a242d 0%, #0f1923 100%);
            border-radius: 16px;
            border: 2px solid #2c3e50;
            box-shadow: 0 0 40px rgba(239, 68, 68, 0.2);
        }

        .multiplier-glow {
            text-shadow: 0 0 30px rgba(239, 68, 68, 0.8), 0 0 60px rgba(239, 68, 68, 0.4);
        }

        .crash-flash {
            animation: crashFlash 0.5s ease-out;
        }

        @keyframes crashFlash {
            0% { background-color: rgba(239, 68, 68, 0.3); }
            100% { background-color: transparent; }
        }

        .bet-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f1923 100%);
            border: 1px solid #334155;
        }

        .live-player-row {
            background: rgba(30, 41, 59, 0.8);
            border-left: 3px solid transparent;
            transition: all 0.3s;
        }

        .live-player-row:hover {
            background: rgba(51, 65, 85, 0.8);
        }

        .live-player-row.cashed {
            border-left-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .live-player-row.crashed {
            border-left-color: #ef4444;
        }

        .live-player-row.user-row {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.15);
        }

        .action-btn {
            background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%);
            box-shadow: 0 6px 0 #15803d, 0 8px 20px rgba(0,0,0,0.4);
            transition: all 0.1s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 0 #15803d, 0 12px 25px rgba(0,0,0,0.5);
        }

        .action-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #15803d, 0 4px 10px rgba(0,0,0,0.3);
        }

        .action-btn.bet-placed {
            background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 6px 0 #b91c1c, 0 8px 20px rgba(0,0,0,0.4);
        }

        .action-btn.bet-placed:hover {
            box-shadow: 0 8px 0 #b91c1c, 0 12px 25px rgba(0,0,0,0.5);
        }

        .action-btn.bet-placed:active {
            box-shadow: 0 2px 0 #b91c1c, 0 4px 10px rgba(0,0,0,0.3);
        }

        .action-btn.cashout {
            background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 6px 0 #b45309, 0 8px 20px rgba(0,0,0,0.4);
        }

        .action-btn.cashout:hover {
            box-shadow: 0 8px 0 #b45309, 0 12px 25px rgba(0,0,0,0.5);
        }

        .action-btn.cashout:active {
            box-shadow: 0 2px 0 #b45309, 0 4px 10px rgba(0,0,0,0.3);
        }

        .history-badge {
            animation: popIn 0.3s ease-out;
        }

        @keyframes popIn {
            0% { transform: scale(0); }
            80% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .tab-btn.active {
            background: linear-gradient(180deg, #2c3e50 0%, #1e293b 100%);
            color: white;
        }

        .countdown-ring {
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            animation: countdown 10s linear;
        }

        @keyframes countdown {
            from { stroke-dashoffset: 0; }
            to { stroke-dashoffset: 283; }
        }
    </style>
</head>
<body class="bg-[#0f1923] min-h-screen">

    <!-- Header -->
    <header class="bg-[#1a242d] border-b border-gray-700 sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="text-red-500 font-black text-3xl italic tracking-tighter flex items-center gap-2">
                    <svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                    </svg>
                    AVIATOR
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex flex-col items-end">
                    <span class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Balance</span>
                    <span id="user-balance" class="text-green-400 font-black font-mono text-xl">₹10,000.00</span>
                </div>
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-red-500 to-red-700 border-2 border-red-400 flex items-center justify-center font-bold text-sm">
                    U
                </div>
                <a href="admin.html" target="_blank" class="text-xs text-gray-500 hover:text-white transition">Admin</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-4 space-y-4">

        <!-- Game Section -->
        <section class="game-canvas relative overflow-hidden">
            <!-- History Bar -->
            <div class="absolute top-0 left-0 right-0 h-12 bg-black/40 backdrop-blur flex items-center px-4 z-10">
                <span class="text-xs text-gray-400 uppercase tracking-widest mr-4">History</span>
                <div id="history-container" class="flex space-x-2 overflow-x-auto flex-1"></div>
            </div>

            <!-- Game Canvas -->
            <canvas id="gameCanvas" class="w-full" style="height: 400px;"></canvas>

            <!-- Center Overlay -->
            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                <div id="multiplier-display" class="text-7xl md:text-9xl font-black text-white multiplier-glow transition-all duration-100">1.00x</div>
                <div id="game-status" class="mt-4 text-2xl md:text-3xl font-black text-red-500 uppercase tracking-widest hidden">FLEW AWAY!</div>
            </div>

            <!-- Live Payout Display -->
            <div class="absolute bottom-4 left-4 bg-black/60 backdrop-blur rounded-xl px-6 py-4 border border-gray-700">
                <p class="text-xs uppercase tracking-[0.3em] text-gray-400 mb-1">Live Payout</p>
                <p id="live-payout" class="text-3xl font-black text-white">₹0.00</p>
            </div>

            <!-- Loading Overlay -->
            <div id="loading-overlay" class="absolute inset-0 bg-black/70 backdrop-blur-md flex flex-col items-center justify-center z-20">
                <div class="relative">
                    <svg class="w-32 h-32 transform -rotate-90">
                        <circle cx="64" cy="64" r="58" stroke="#374151" stroke-width="8" fill="none"/>
                        <circle id="countdown-circle" cx="64" cy="64" r="58" stroke="#ef4444" stroke-width="8" fill="none" class="countdown-ring" style="stroke-dasharray: 364;"/>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="countdown" class="text-4xl font-black text-white">10</span>
                    </div>
                </div>
                <p class="mt-4 text-gray-300 font-medium">Next Round Starting...</p>
                <p class="text-sm text-gray-500 mt-1">Place your bets now!</p>
            </div>
        </section>

        <!-- Betting Section -->
        <section class="bet-card rounded-2xl p-6">
            <!-- Tabs -->
            <div class="flex bg-[#0f1923] rounded-xl p-1 mb-6 w-fit">
                <button id="tab-bet" class="tab-btn active px-6 py-2 rounded-lg text-sm font-bold text-gray-400 transition-all">Manual Bet</button>
                <button id="tab-auto" class="tab-btn px-6 py-2 rounded-lg text-sm font-bold text-gray-400 transition-all">Auto Bet</button>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <!-- Bet Amount Section -->
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-400 uppercase tracking-wider font-bold">Bet Amount</label>
                        <div class="flex items-center gap-2 mt-2">
                            <button onclick="adjustBet(-20)" class="w-12 h-12 rounded-xl bg-[#1e293b] hover:bg-[#334155] text-gray-300 hover:text-white font-black text-xl transition-all">−</button>
                            <input type="number" id="bet-amount" value="20.00" class="flex-1 bg-[#0f1923] border-2 border-gray-700 rounded-xl px-4 py-3 text-center font-black text-xl text-white focus:outline-none focus:border-red-500 transition-all" step="10" min="20">
                            <button onclick="adjustBet(20)" class="w-12 h-12 rounded-xl bg-[#1e293b] hover:bg-[#334155] text-gray-300 hover:text-white font-black text-xl transition-all">+</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="setBet(100)" class="bg-[#1e293b] hover:bg-[#334155] rounded-xl py-3 text-sm font-bold text-gray-400 hover:text-white transition-all">₹100</button>
                        <button onclick="setBet(200)" class="bg-[#1e293b] hover:bg-[#334155] rounded-xl py-3 text-sm font-bold text-gray-400 hover:text-white transition-all">₹200</button>
                        <button onclick="setBet(500)" class="bg-[#1e293b] hover:bg-[#334155] rounded-xl py-3 text-sm font-bold text-gray-400 hover:text-white transition-all">₹500</button>
                        <button onclick="setBet(1000)" class="bg-[#1e293b] hover:bg-[#334155] rounded-xl py-3 text-sm font-bold text-gray-400 hover:text-white transition-all">₹1000</button>
                    </div>
                </div>

                <!-- Auto Controls Section -->
                <div id="auto-controls" class="space-y-4 hidden">
                    <!-- Auto Bet Toggle -->
                    <div class="bg-[#0f1923] rounded-xl p-4 border border-gray-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-bold text-white">Auto Bet</p>
                                <p class="text-xs text-gray-400">Automatically place bets each round</p>
                            </div>
                            <label class="toggle-switch" id="auto-bet-toggle">
                                <input type="checkbox" id="auto-bet-checkbox">
                            </label>
                        </div>
                    </div>

                    <!-- Auto Cashout Toggle -->
                    <div class="bg-[#0f1923] rounded-xl p-4 border border-gray-700">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <p class="text-sm font-bold text-white">Auto Cashout</p>
                                <p class="text-xs text-gray-400">Automatically cash out at target</p>
                            </div>
                            <label class="toggle-switch" id="auto-cashout-toggle">
                                <input type="checkbox" id="auto-cashout-checkbox">
                            </label>
                        </div>
                        <div class="flex items-center gap-3">
                            <input type="number" id="auto-cashout-value" value="2.00" step="0.1" min="1.1" class="flex-1 bg-[#1e293b] border border-gray-600 rounded-lg px-4 py-2 text-center font-bold text-white focus:outline-none focus:border-red-500">
                            <span class="text-gray-400 font-bold">x</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Button -->
            <button id="action-btn" class="action-btn w-full mt-6 rounded-2xl py-5 text-white font-black text-2xl tracking-wider">
                BET
            </button>
        </section>

        <!-- Live Bets Section -->
        <section class="bet-card rounded-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-xl font-black text-white flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        Live Bets
                    </h2>
                    <p class="text-sm text-gray-400">Real-time player activity</p>
                </div>
                <div class="bg-[#0f1923] rounded-xl px-4 py-2 border border-gray-700">
                    <span class="text-xs text-gray-400 uppercase tracking-wider">Players</span>
                    <span id="total-players" class="ml-2 font-black text-white text-lg">0</span>
                </div>
            </div>

            <!-- Header Row -->
            <div class="hidden md:grid grid-cols-12 gap-4 text-xs uppercase tracking-widest text-gray-500 px-4 py-3 border-b border-gray-700">
                <div class="col-span-4">Player</div>
                <div class="col-span-3 text-center">Bet Amount</div>
                <div class="col-span-3 text-center">Multiplier</div>
                <div class="col-span-2 text-right">Winning</div>
            </div>

            <!-- Players List -->
            <div id="live-bets-container" class="space-y-2 max-h-[500px] overflow-y-auto pr-2" style="min-height: 300px;">
                <!-- Players will be rendered here -->
            </div>
        </section>

    </main>

    <script>
        // Plane SVG for canvas
        const planeSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 60">
            <defs>
                <linearGradient id="planeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#ef4444"/>
                    <stop offset="100%" style="stop-color:#b91c1c"/>
                </linearGradient>
            </defs>
            <path fill="url(#planeGrad)" d="M5 35 L90 30 L100 15 L80 18 L65 32 L5 35 Z"/>
            <path fill="#f87171" d="M15 40 L85 35 L95 45 L78 48 L50 42 L15 40 Z"/>
            <path fill="#dc2626" d="M25 20 L45 18 L52 35 L28 33 Z"/>
            <circle cx="75" cy="22" r="4" fill="#fbbf24"/>
        </svg>`;

        // Game State
        const state = {
            balance: 10000,
            betAmount: 20,
            isBetPlaced: false,
            isBetActive: false,
            didCashOut: false,
            cashOutMultiplier: 0,
            gameState: 'WAITING', // WAITING, FLYING, CRASHED
            multiplier: 1.00,
            crashPoint: 0,
            flightTime: 0,
            countdown: 10,
            autoBet: false,
            autoCashout: false,
            autoCashoutValue: 2.00,
            history: [],
            players: []
        };

        // Bot names
        const botNames = [
            "RajKumar99", "DesiBoy", "MumbaiKing", "DelhiDasher", "BangaloreBet",
            "ChennaiChamp", "KolkataKnight", "HyderabadHero", "PunePlayer", "AhmedabadAce",
            "LucknowLegend", "GujaratGamer", "PunjabPower", "HaryanaHit", "MPMaster",
            "UPWinner", "BiharBoss", "RajasthanRoy", "KeralaKing", "TamilTiger",
            "TelanganaTop", "KarnatakaStar", "MaharashtraMan", "GoaGambler", "AssamAce",
            "OdishaOwner", "WestBengalWinner", "JharkhandJackpot", "ChhattisgarhChamp", "UttarakhandUni",
            "HimachalHero", "PunjabPrince", "SikkimStar", "ManipurMaster", "MeghalayaMoney",
            "TripuraTop", "NagalandNinja", "ArunachalAce", "MizoramMoney", "NagpurNoble",
            "IndoreIcon", "BhopalBoss", "JaipurJewel", "LucknowLucky", "KanpurKing",
            "SuratStar", "VadodaraVictor", "NagpurNinja", "IndoreIcon", "CoimbatoreChamp",
            "MaduraiMoney", "TrichyTop", "SalemStar", "ErodeExpert", "TirupurTiger"
        ];

        // DOM Elements
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const planeImg = new Image();
        let planeImgLoaded = false;

        planeImg.onload = () => planeImgLoaded = true;
        planeImg.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(planeSvg);

        // Currency formatter
        const formatCurrency = (amount) => {
            return '₹' + amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        // Initialize canvas
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth;
            canvas.height = 400;
        }

        // Setup UI
        function setupUI() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // Tab switching
            document.getElementById('tab-bet').addEventListener('click', () => switchTab('bet'));
            document.getElementById('tab-auto').addEventListener('click', () => switchTab('auto'));

            // Bet amount input
            document.getElementById('bet-amount').addEventListener('change', (e) => {
                let val = parseFloat(e.target.value) || 20;
                if (val < 20) val = 20;
                if (val > state.balance) val = state.balance;
                state.betAmount = val;
                e.target.value = val.toFixed(2);
                updateButton();
            });

            // Auto bet toggle
            document.getElementById('auto-bet-toggle').addEventListener('click', function() {
                const checkbox = document.getElementById('auto-bet-checkbox');
                checkbox.checked = !checkbox.checked;
                state.autoBet = checkbox.checked;
                this.classList.toggle('active', state.autoBet);
            });

            // Auto cashout toggle
            document.getElementById('auto-cashout-toggle').addEventListener('click', function() {
                const checkbox = document.getElementById('auto-cashout-checkbox');
                checkbox.checked = !checkbox.checked;
                state.autoCashout = checkbox.checked;
                this.classList.toggle('active', state.autoCashout);
            });

            // Auto cashout value
            document.getElementById('auto-cashout-value').addEventListener('change', (e) => {
                let val = parseFloat(e.target.value) || 2.00;
                if (val < 1.1) val = 1.1;
                state.autoCashoutValue = val;
                e.target.value = val.toFixed(2);
            });

            // Action button
            document.getElementById('action-btn').addEventListener('click', handleAction);

            updateBalanceDisplay();
            generatePlayers();
            startCountdown();
            requestAnimationFrame(gameLoop);
        }

        // Switch tabs
        function switchTab(tab) {
            const betTab = document.getElementById('tab-bet');
            const autoTab = document.getElementById('tab-auto');
            const autoControls = document.getElementById('auto-controls');

            if (tab === 'bet') {
                betTab.classList.add('active');
                autoTab.classList.remove('active');
                autoControls.classList.add('hidden');
            } else {
                autoTab.classList.add('active');
                betTab.classList.remove('active');
                autoControls.classList.remove('hidden');
            }
        }

        // Adjust bet amount
        function adjustBet(amount) {
            let newVal = state.betAmount + amount;
            if (newVal < 20) newVal = 20;
            if (newVal > state.balance) newVal = state.balance;
            state.betAmount = newVal;
            document.getElementById('bet-amount').value = newVal.toFixed(2);
            updateButton();
        }

        // Set bet amount
        function setBet(amount) {
            if (amount <= state.balance) {
                state.betAmount = amount;
                document.getElementById('bet-amount').value = amount.toFixed(2);
                updateButton();
            }
        }

        // Handle action button click
        function handleAction() {
            if (state.gameState === 'WAITING') {
                if (state.isBetPlaced) {
                    state.isBetPlaced = false;
                } else {
                    if (state.betAmount > state.balance) {
                        alert('Insufficient balance!');
                        return;
                    }
                    state.isBetPlaced = true;
                }
            } else if (state.gameState === 'FLYING') {
                if (state.isBetActive && !state.didCashOut) {
                    cashOut();
                }
            }
            updateButton();
        }

        // Cash out
        function cashOut() {
            if (!state.isBetActive || state.didCashOut) return;
            
            state.didCashOut = true;
            state.cashOutMultiplier = state.multiplier;
            const winnings = state.betAmount * state.multiplier;
            state.balance += winnings;
            
            updateBalanceDisplay();
            updateButton();
            updateUserRow(true);
        }

        // Update button
        function updateButton() {
            const btn = document.getElementById('action-btn');
            
            if (state.gameState === 'WAITING') {
                if (state.isBetPlaced || state.autoBet) {
                    btn.className = 'action-btn bet-placed w-full mt-6 rounded-2xl py-5 text-white font-black text-2xl tracking-wider';
                    btn.textContent = 'CANCEL BET';
                } else {
                    btn.className = 'action-btn w-full mt-6 rounded-2xl py-5 text-white font-black text-2xl tracking-wider';
                    btn.textContent = `BET ${formatCurrency(state.betAmount)}`;
                }
            } else if (state.gameState === 'FLYING') {
                if (state.isBetActive && !state.didCashOut) {
                    btn.className = 'action-btn cashout w-full mt-6 rounded-2xl py-5 text-white font-black text-2xl tracking-wider';
                    btn.textContent = `CASH OUT ${formatCurrency(state.betAmount * state.multiplier)}`;
                } else if (state.didCashOut) {
                    btn.className = 'bg-gray-600 w-full mt-6 rounded-2xl py-5 text-gray-400 font-black text-2xl tracking-wider cursor-not-allowed';
                    btn.textContent = `CASHED OUT @ ${state.cashOutMultiplier.toFixed(2)}x`;
                } else {
                    btn.className = 'bg-gray-600 w-full mt-6 rounded-2xl py-5 text-gray-400 font-black text-2xl tracking-wider cursor-not-allowed';
                    btn.textContent = 'WAITING FOR NEXT ROUND';
                }
            } else {
                btn.className = 'bg-gray-600 w-full mt-6 rounded-2xl py-5 text-gray-400 font-black text-2xl tracking-wider cursor-not-allowed';
                btn.textContent = 'CRASHED - NEXT ROUND SOON';
            }
        }

        // Update balance display
        function updateBalanceDisplay() {
            document.getElementById('user-balance').textContent = formatCurrency(state.balance);
        }

        // Start countdown
        function startCountdown() {
            state.gameState = 'WAITING';
            state.countdown = 10;
            state.multiplier = 1.00;
            state.flightTime = 0;
            state.isBetActive = false;
            state.didCashOut = false;

            // Auto bet
            if (state.autoBet) {
                state.isBetPlaced = true;
            }

            // Generate crash point based on Admin Settings
            const settings = JSON.parse(localStorage.getItem('aviator_admin_settings') || '{}');
            const rtp = settings.rtp !== undefined ? settings.rtp / 100 : 0.99; // Default 99% if not set
            const forceCrash = settings.forceCrash || false;

            if (forceCrash) {
                state.crashPoint = 1.00;
                // Reset force crash after one use
                settings.forceCrash = false;
                localStorage.setItem('aviator_admin_settings', JSON.stringify(settings));
            } else {
                const r = Math.random();
                // If RTP is low, increase chance of instant crash (1.00x)
                // Normal instant crash chance is 1% (0.01)
                // We'll scale instant crash chance based on RTP inverse
                const instantCrashChance = 0.01 + (1 - rtp) * 0.2; 
                
                if (r < instantCrashChance) {
                    state.crashPoint = 1.00;
                } else {
                    // Use RTP as the numerator for fair distribution calculation
                    // crashPoint = E / (1-r) where E is expected return
                    state.crashPoint = rtp / (1 - r);
                    
                    // Cap max win based on profit settings (simulated)
                    // If RTP is very low, we cap the max multiplier harder
                    const maxCap = rtp < 0.5 ? 10 : 100; 
                    if (state.crashPoint > maxCap) state.crashPoint = maxCap;
                }
            }

            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('game-status').classList.add('hidden');
            
            const multiplierDisplay = document.getElementById('multiplier-display');
            multiplierDisplay.classList.remove('text-red-500');
            multiplierDisplay.classList.add('text-white');
            multiplierDisplay.textContent = '1.00x';

            generatePlayers();
            renderPlayers();
            updateButton();
            updateLivePayout();
        }

        // Start game
        function startGame() {
            state.gameState = 'FLYING';
            document.getElementById('loading-overlay').classList.add('hidden');

            if (state.isBetPlaced && state.betAmount <= state.balance) {
                state.isBetActive = true;
                state.balance -= state.betAmount;
                updateBalanceDisplay();
            }
            state.isBetPlaced = false;
            updateButton();
        }

        // Crash game
        function crashGame() {
            state.gameState = 'CRASHED';
            
            document.getElementById('game-status').classList.remove('hidden');
            document.getElementById('multiplier-display').classList.remove('text-white');
            document.getElementById('multiplier-display').classList.add('text-red-500');
            
            canvas.classList.add('crash-flash');
            setTimeout(() => canvas.classList.remove('crash-flash'), 500);

            addToHistory(state.crashPoint);
            updatePlayersCrashed();
            updateButton();

            setTimeout(startCountdown, 3000);
        }

        // Add to history
        function addToHistory(value) {
            state.history.unshift(value);
            if (state.history.length > 20) state.history.pop();

            const container = document.getElementById('history-container');
            const badge = document.createElement('div');
            badge.className = `history-badge px-3 py-1 rounded-lg text-sm font-bold ${value >= 2.00 ? 'bg-purple-600' : value >= 1.5 ? 'bg-blue-600' : value < 1.1 ? 'bg-red-600' : 'bg-cyan-600'}`;
            badge.textContent = value.toFixed(2) + 'x';
            container.insertBefore(badge, container.firstChild);

            if (container.children.length > 20) {
                container.removeChild(container.lastChild);
            }
        }

        // Generate players
        function generatePlayers() {
            state.players = [];
            const numPlayers = Math.floor(Math.random() * 30) + 50;

            // Add user if betting
            if (state.isBetPlaced || state.autoBet) {
                state.players.push({
                    name: 'YOU',
                    bet: state.betAmount,
                    cashoutAt: null,
                    isUser: true,
                    cashed: false
                });
            }

            // Generate bots
            for (let i = 0; i < numPlayers; i++) {
                const name = botNames[Math.floor(Math.random() * botNames.length)] + Math.floor(Math.random() * 1000);
                const bet = parseFloat((Math.random() * 2000 + 20).toFixed(2));
                let cashoutAt = null;
                
                // Determine cashout strategy
                const strategy = Math.random();
                if (strategy < 0.4) {
                    cashoutAt = parseFloat((1.1 + Math.random() * 0.9).toFixed(2)); // 1.1x - 2x
                } else if (strategy < 0.7) {
                    cashoutAt = parseFloat((2 + Math.random() * 3).toFixed(2)); // 2x - 5x
                } else if (strategy < 0.9) {
                    cashoutAt = parseFloat((5 + Math.random() * 5).toFixed(2)); // 5x - 10x
                }

                state.players.push({
                    name: name,
                    bet: bet,
                    cashoutAt: cashoutAt,
                    isUser: false,
                    cashed: false
                });
            }

            document.getElementById('total-players').textContent = state.players.length;
        }

        // Render players
        function renderPlayers() {
            const container = document.getElementById('live-bets-container');
            container.innerHTML = '';

            state.players.forEach((player, index) => {
                const row = document.createElement('div');
                row.className = `live-player-row rounded-xl px-4 py-3 ${player.isUser ? 'user-row' : ''}`;
                row.id = `player-${index}`;

                const avatar = player.isUser 
                    ? '<div class="w-8 h-8 rounded-full bg-amber-500 flex items-center justify-center font-bold text-sm">U</div>'
                    : `<img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${player.name}" class="w-8 h-8 rounded-full bg-gray-600">`;

                row.innerHTML = `
                    <div class="grid grid-cols-12 gap-4 items-center text-sm">
                        <div class="col-span-4 flex items-center gap-3">
                            ${avatar}
                            <span class="font-medium truncate ${player.isUser ? 'text-amber-400 font-bold' : 'text-white'}">${player.name}</span>
                        </div>
                        <div class="col-span-3 text-center font-mono text-white">${formatCurrency(player.bet)}</div>
                        <div class="col-span-3 text-center">
                            <span id="multiplier-${index}" class="font-mono text-gray-400">Awaiting</span>
                        </div>
                        <div class="col-span-2 text-right">
                            <span id="winning-${index}" class="font-mono text-gray-500">-</span>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        // Update players during flight
        function updatePlayers(currentMultiplier) {
            state.players.forEach((player, index) => {
                if (player.cashed || !player.cashoutAt) return;

                // Update live multiplier
                const multEl = document.getElementById(`multiplier-${index}`);
                const winEl = document.getElementById(`winning-${index}`);
                
                if (multEl && winEl) {
                    const liveWinning = player.bet * currentMultiplier;
                    multEl.innerHTML = `<span class="text-yellow-400 font-bold">${currentMultiplier.toFixed(2)}x</span>`;
                    winEl.innerHTML = `<span class="text-gray-300">${formatCurrency(liveWinning)}</span>`;

                    // Check if should cashout
                    if (currentMultiplier >= player.cashoutAt) {
                        player.cashed = true;
                        const winning = player.bet * player.cashoutAt;
                        multEl.innerHTML = `<span class="text-green-400 font-bold">${player.cashoutAt.toFixed(2)}x</span>`;
                        winEl.innerHTML = `<span class="text-green-400">+${formatCurrency(winning)}</span>`;
                        document.getElementById(`player-${index}`).classList.add('cashed');
                    }
                }
            });
        }

        // Update players on crash
        function updatePlayersCrashed() {
            state.players.forEach((player, index) => {
                if (player.cashed) return;

                const multEl = document.getElementById(`multiplier-${index}`);
                const winEl = document.getElementById(`winning-${index}`);
                
                if (multEl && winEl) {
                    multEl.innerHTML = `<span class="text-red-400 font-bold">CRASH</span>`;
                    winEl.innerHTML = `<span class="text-red-400">-${formatCurrency(player.bet)}</span>`;
                    document.getElementById(`player-${index}`).classList.add('crashed');
                }
            });
        }

        // Update user row
        function updateUserRow(cashed) {
            const userIndex = state.players.findIndex(p => p.isUser);
            if (userIndex === -1) return;

            const player = state.players[userIndex];
            player.cashed = cashed;
            player.cashoutAt = state.cashOutMultiplier;

            const multEl = document.getElementById(`multiplier-${userIndex}`);
            const winEl = document.getElementById(`winning-${userIndex}`);
            
            if (multEl && winEl) {
                const winning = player.bet * player.cashoutAt;
                multEl.innerHTML = `<span class="text-green-400 font-bold">${player.cashoutAt.toFixed(2)}x</span>`;
                winEl.innerHTML = `<span class="text-green-400">+${formatCurrency(winning)}</span>`;
                document.getElementById(`player-${userIndex}`).classList.add('cashed');
            }
        }

        // Update live payout
        function updateLivePayout() {
            const el = document.getElementById('live-payout');
            if (state.gameState === 'FLYING' && state.isBetActive && !state.didCashOut) {
                el.textContent = formatCurrency(state.betAmount * state.multiplier);
            } else if (state.isBetPlaced && state.gameState === 'WAITING') {
                el.textContent = `Bet: ${formatCurrency(state.betAmount)}`;
            } else {
                el.textContent = '₹0.00';
            }
        }

        // Update countdown UI
        function updateCountdownUI(dt) {
            state.countdown -= dt;
            if (state.countdown <= 0) {
                state.countdown = 0;
                startGame();
            }

            document.getElementById('countdown').textContent = Math.ceil(state.countdown);
            const circle = document.getElementById('countdown-circle');
            const offset = 364 * (1 - state.countdown / 10);
            circle.style.strokeDashoffset = offset;
        }

        // Draw grid
        function drawGrid() {
            ctx.strokeStyle = '#1e293b';
            ctx.lineWidth = 1;

            for (let i = 0; i < canvas.width; i += 50) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }
            for (let i = 0; i < canvas.height; i += 50) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(canvas.width, i);
                ctx.stroke();
            }
        }

        // Draw curve
        function drawCurve() {
            if (state.flightTime <= 0) return;

            const w = canvas.width;
            const h = canvas.height;

            ctx.beginPath();
            ctx.strokeStyle = '#ef4444';
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';

            let tipX = state.flightTime * 80;
            let tipY = h - ((state.multiplier - 1) * 80);

            if (tipX > w - 50) tipX = w - 50;
            if (tipY < 60) tipY = 60;

            ctx.moveTo(0, h);
            ctx.quadraticCurveTo(tipX * 0.3, h, tipX, tipY);
            ctx.stroke();

            // Fill gradient
            ctx.lineTo(tipX, h);
            ctx.lineTo(0, h);
            ctx.closePath();

            const gradient = ctx.createLinearGradient(0, 0, 0, h);
            gradient.addColorStop(0, 'rgba(239, 68, 68, 0.3)');
            gradient.addColorStop(1, 'rgba(239, 68, 68, 0)');
            ctx.fillStyle = gradient;
            ctx.fill();
        }

        // Draw plane
        function drawPlane() {
            if (state.flightTime <= 0) return;

            const w = canvas.width;
            const h = canvas.height;

            let tipX = state.flightTime * 80;
            let tipY = h - ((state.multiplier - 1) * 80);

            if (tipX > w - 50) tipX = w - 50;
            if (tipY < 60) tipY = 60;

            // Calculate rotation
            const rotation = Math.min(0.5, (state.multiplier - 1) * 0.1);

            ctx.save();
            ctx.translate(tipX, tipY);
            ctx.rotate(-rotation);

            if (planeImgLoaded) {
                ctx.drawImage(planeImg, -35, -15, 70, 35);
            } else {
                // Fallback plane
                ctx.fillStyle = '#ef4444';
                ctx.beginPath();
                ctx.moveTo(30, 0);
                ctx.lineTo(-20, 10);
                ctx.lineTo(-20, -10);
                ctx.closePath();
                ctx.fill();
            }

            ctx.restore();
        }

        // Game loop
        let lastTime = 0;
        function gameLoop(timestamp) {
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;

            // Clear and draw
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawGrid();

            if (state.gameState === 'WAITING') {
                updateCountdownUI(dt);
            } else if (state.gameState === 'FLYING') {
                state.flightTime += dt;
                state.multiplier = Math.pow(Math.E, 0.15 * state.flightTime);

                // Check crash
                if (state.multiplier >= state.crashPoint) {
                    state.multiplier = state.crashPoint;
                    crashGame();
                }

                // Auto cashout
                if (state.isBetActive && !state.didCashOut && state.autoCashout && state.multiplier >= state.autoCashoutValue) {
                    cashOut();
                }

                // Update players
                updatePlayers(state.multiplier);

                // Draw
                drawCurve();
                drawPlane();
            } else if (state.gameState === 'CRASHED') {
                drawCurve();
            }

            // Update displays
            document.getElementById('multiplier-display').textContent = state.multiplier.toFixed(2) + 'x';
            updateLivePayout();

            if (state.gameState === 'FLYING' && state.isBetActive && !state.didCashOut) {
                updateButton();
            }

            requestAnimationFrame(gameLoop);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', setupUI);
    </script>
</body>
</html>
